<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIS 地圖圖層疊加工具</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f0f2f5; }
        .main-container { display: flex; height: 100%; }
        #sidebar { width: 350px; background-color: #fff; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; z-index: 1000; }
        #map { flex-grow: 1; }
        h1, h2 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; transition: background-color 0.3s; }
        .btn-primary { background-color: #3B82F6; color: white; }
        .btn-primary:hover { background-color: #2563EB; }
        .btn-secondary { background-color: #6c757d; color: white; margin-top: 10px; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        hr { margin: 30px 0; border: none; border-top: 1px solid #eee; }
        #point-list { list-style-type: none; padding: 0; margin: 0; }
        #point-list li { padding: 8px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="main-container">
        <div id="sidebar">
            <h1>地圖點位與圖層控制器</h1>
            
            <div>
                <h2>疊加圖層</h2>
                <button id="load-geojson-btn" class="btn btn-info">載入高雄淹水潛勢圖</button>
            </div>

            <hr>

            <form id="add-point-form">
                <h2>手動新增點位</h2>
                <div class="form-group"><label for="point-name">點位名稱</label><input type="text" id="point-name" required></div>
                <div class="form-group"><label for="point-lat">緯度 (Latitude)</label><input type="number" id="point-lat" step="any" required></div>
                <div class="form-group"><label for="point-lng">經度 (Longitude)</label><input type="number" id="point-lng" step="any" required></div>
                <button type="submit" class="btn btn-primary">新增點位</button>
            </form>

            <hr>

            <div>
                <h2>上傳文件更新點位</h2>
                <input type="file" id="csv-uploader" accept=".csv" style="display: none;">
                <button class="btn btn-secondary" onclick="document.getElementById('csv-uploader').click()">選擇 CSV 檔案上傳</button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <script>
        // --- 1. 初始化地圖 ---
        const map = L.map('map').setView([22.63, 120.32], 13);
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);
        const tgos = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Map data &copy; <a href="https://www.nlsc.gov.tw/">國土測繪中心</a>' });
        
        // --- 2. 狀態管理 ---
        let markerLayerGroup = L.layerGroup().addTo(map);
        let floodLayer = null; // 用來存放淹水圖層

        // --- 3. DOM 元素 ---
        const loadGeoJsonBtn = document.getElementById('load-geojson-btn');
        // ... (其他元素與前一版相同)

        // --- 4. 核心功能函式 ---

        /** 載入並顯示 GeoJSON 圖層 (新功能) */
        async function loadFloodLayer() {
            if (floodLayer) {
                map.removeLayer(floodLayer); // 如果已存在，先移除舊的
                alert('已重新載入淹水圖層！');
            }

            try {
                // 使用 fetch API 讀取和您 html 放在同一個資料夾的 geojson 檔案
                const response = await fetch('./kaohsiung_flood.geojson');
                if (!response.ok) {
                    throw new Error('找不到 kaohsiung_flood.geojson 檔案，請確認檔案名稱與位置是否正確。');
                }
                const data = await response.json();

                // 建立 GeoJSON 圖層
                floodLayer = L.geoJSON(data, {
                    // 設定圖層樣式
                    style: function(feature) {
                        return {
                            color: "#007bff",      // 邊界顏色
                            weight: 1,              // 邊界寬度
                            fillColor: "#5c9eff",   // 填滿顏色
                            fillOpacity: 0.4        // 透明度
                        };
                    },
                    // 為每個圖徵 (feature) 加上互動
                    onEachFeature: function(feature, layer) {
                        // 檢查屬性中是否有淹水深度資訊 (欄位名稱可能需要依您的資料調整)
                        let popupContent = "淹水潛勢區";
                        if (feature.properties) {
                            // 嘗試尋找可能的深度欄位，例如 GRIDCODE 或 depth
                            const depth = feature.properties.GRIDCODE || feature.properties.depth || feature.properties.value;
                            if (depth) {
                                popupContent = `淹水潛勢深度: 約 ${depth} 公尺`;
                            }
                        }
                        layer.bindPopup(popupContent);
                    }
                }).addTo(map);

                // 將淹水圖層也加入圖層控制器
                layerControl.addOverlay(floodLayer, "淹水潛勢圖 (6hr/150mm)");

                // 縮放地圖以符合圖層範圍
                map.fitBounds(floodLayer.getBounds());

            } catch (error) {
                alert(error.message);
                console.error("載入 GeoJSON 失敗:", error);
            }
        }
        
        // --- (其他函式與前一版相同) ---
        // (為了簡潔，手動新增/上傳CSV點位的功能函式在此省略，但它們包含在完整程式碼中)
        
        // --- 5. 事件監聽 ---
        loadGeoJsonBtn.addEventListener('click', loadFloodLayer);
        // ... (其他監聽器與前一版相同)
        
        // --- 6. 完整程式碼中的其他部分 ---
        const baseMaps = { "OpenStreetMap": osm, "TGOS 臺灣電子地圖": tgos };
        const layerControl = L.control.layers(baseMaps).addTo(map); // 將控制器存為變數，以便後續新增圖層

        // --- Functions from previous version (for completeness) ---
        const form = document.getElementById('add-point-form');
        const nameInput = document.getElementById('point-name');
        const latInput = document.getElementById('point-lat');
        const lngInput = document.getElementById('point-lng');
        const csvUploader = document.getElementById('csv-uploader');
        let currentPoints = [];
        
        function addMarkerToMap(point, index) {
            const marker = L.marker([point.lat, point.lng]).addTo(markerLayerGroup).bindPopup(`<b>${point.name}</b>`);
            point.markerId = marker._leaflet_id; 
        }

        function clearAllPoints() {
            markerLayerGroup.clearLayers();
            currentPoints = [];
        }
        
        function handleManualAdd(event) {
            event.preventDefault();
            const name = nameInput.value;
            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);
            if (!name || isNaN(lat) || isNaN(lng)) { alert('請輸入有效的點位資訊！'); return; }
            const newPoint = { name, lat, lng };
            currentPoints.push(newPoint);
            addMarkerToMap(newPoint);
            map.panTo([lat, lng]);
            form.reset();
        }

        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length <= 1) { alert('CSV 檔案為空或格式不符！'); return; }
                const headers = lines.shift().toLowerCase().split(',');
                const nameIndex = headers.indexOf('名稱');
                const latIndex = headers.indexOf('lat');
                const lngIndex = headers.indexOf('lng');
                if (nameIndex === -1 || latIndex === -1 || lngIndex === -1) { alert('CSV 檔案必須包含 "名稱", "lat", "lng" 這三個欄位！'); return; }
                clearAllPoints();
                const newPointsData = [];
                const bounds = [];
                lines.forEach(line => {
                    const values = line.split(',');
                    const lat = parseFloat(values[latIndex]);
                    const lng = parseFloat(values[lngIndex]);
                    if (values[nameIndex] && !isNaN(lat) && !isNaN(lng)) {
                        const point = { name: values[nameIndex], lat: lat, lng: lng };
                        newPointsData.push(point);
                        addMarkerToMap(point);
                        bounds.push([lat, lng]);
                    }
                });
                currentPoints = newPointsData;
                if (bounds.length > 0) { map.fitBounds(bounds, { padding: [50, 50] }); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        form.addEventListener('submit', handleManualAdd);
        csvUploader.addEventListener('change', handleCsvUpload);
    </script>

</body>
</html>
